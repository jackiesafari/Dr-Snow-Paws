<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4D96FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dr. Snow Paws - Your Friendly Pet Doctor</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Bubblegum+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/mobile.css">
    <style>
        .avatar-container {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 10px auto 0;  /* Reduced top margin */
        }

        .avatar-controls {
            position: absolute;
            top: 20px;
            right: -110px; /* Position outside the video wrapper */
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .audio-control {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;  /* Slightly smaller */
            height: 36px;  /* Slightly smaller */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .voice-control {
            position: absolute;
            top: 15px;
            right: 60px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;  /* Slightly smaller */
            height: 36px;  /* Slightly smaller */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .audio-control:hover, .voice-control:hover {
            transform: scale(1.1);
        }

        .audio-control:active, .voice-control:active {
            transform: scale(0.95);
        }

        .audio-control.muted .audio-icon {
            content: "ðŸ”‡";
        }

        .voice-control.listening {
            background: rgba(255, 82, 82, 0.9);
            animation: pulse 1.5s infinite;
        }

        .voice-control.listening .voice-icon {
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Ensure the video stays within its container */
        .video-wrapper video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 15px;
        }

        /* Emotion bubble styles - much shorter height */
        #emotion-bubble {
            position: absolute;
            top: auto;  /* Reset top position */
            bottom: -25px;  /* Position below avatar */
            left: 50%;
            transform: translateX(-50%);
            background: #98f5c4;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 90;
            width: fit-content;
            min-width: 80px;
            max-width: 140px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            height: auto;
        }

        /* Container to help position elements */
        #avatar-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding-top: 40px; /* Increased space for the emotion bubble */
        }

        /* Add visual feedback for voice recognition */
        .voice-feedback {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
        }

        .voice-feedback.visible {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="avatar-chat-wrapper">
            <div id="avatar-container">
                <div class="video-wrapper">
                    <video id="avatar-video" 
                        autoplay 
                        loop 
                        playsinline 
                        muted 
                        preload="auto"
                        style="opacity: 0; background: #f0f0f0;"
                        oncanplay="this.style.opacity = 1">
                        <source src="/static/assets/videos/default.mp4" type="video/mp4">
                    </video>
                    <div class="video-overlay"></div>
                </div>
                <div id="emotion-bubble" class="happy">Happy to help! ðŸ˜Š</div>
                <button id="voice-input" class="voice-control" aria-label="Voice input">
                    <span class="voice-icon">ðŸŽ¤</span>
                </button>
                <button id="toggle-audio" class="audio-control" aria-label="Toggle audio">
                    <span class="audio-icon">ðŸ”Š</span>
                </button>
            </div>
            <div id="chat-container" class="touch-scroll">
                <!-- Messages will be added here -->
            </div>
        </div>
            <div id="input-container">
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="Type your message here..." aria-label="Type your message">
                <div class="input-emoji-button" role="button" aria-label="Add emoji">ðŸ˜Š</div>
            </div>
            <button id="send-button" aria-label="Send message">
                <span class="button-text">Send / Enviar</span>
                <span class="button-icon">âœ¨</span>
            </button>
        </div>
    </div>
    
    <div id="voice-feedback" class="voice-feedback">Listening...</div>

    <script src="/static/js/mobile.js"></script>
    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 2000;
        let currentLanguage = 'en';  // Default to English
        let isSpeechEnabled = true;

        // Global audio context and settings
        let audioContext = null;
        let currentAudioSource = null;

        function initializeAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    latencyHint: 'interactive',
                    sampleRate: 44100
                });
            }
            return audioContext;
        }

        // Force video autoplay
        window.addEventListener('load', function() {
            const video = document.getElementById('avatar-video');
            const videoWrapper = video.closest('.video-wrapper');
            
            // Show loading state
            videoWrapper.classList.add('loading');
            
            // Try to play video immediately
            const playVideo = async () => {
                try {
                    await video.play();
                    videoWrapper.classList.remove('loading');
                } catch (err) {
                    console.log('Autoplay failed:', err);
                    // Keep trying to play
                    setTimeout(playVideo, 1000);
                }
            };
            
            // Try to play on page load
            playVideo();
            
            // Also try to play on first user interaction
            const startPlayback = () => {
                playVideo();
                document.removeEventListener('touchstart', startPlayback);
                document.removeEventListener('click', startPlayback);
            };
            
            document.addEventListener('touchstart', startPlayback);
            document.addEventListener('click', startPlayback);
            
            // Monitor video state
            video.addEventListener('playing', function() {
                video.style.opacity = 1;
                videoWrapper.classList.remove('loading');
            });
            
            video.addEventListener('pause', function() {
                if (!video.ended) {
                    playVideo();  // Try to resume if paused and not ended
                }
            });
            
            // Handle loading errors
            video.addEventListener('error', function() {
                console.log('Video error:', video.error);
                videoWrapper.classList.add('loading');
                setTimeout(playVideo, 1000);  // Try again after a delay
            });
        });

        const UI_TEXT = {
            en: {
                placeholder: "Type your message here...",
                sendButton: "Send / Enviar",
                happy: "Happy to help! ðŸ˜Š",
                caring: "I'm here for you ðŸ’",
                listening: "I'm listening ðŸ‘‚"
            },
            es: {
                placeholder: "Escribe tu mensaje aquÃ­...",
                sendButton: "Send / Enviar",
                happy: "Â¡Feliz de ayudar! ðŸ˜Š",
                caring: "Estoy aquÃ­ para ti ðŸ’",
                listening: "Te escucho ðŸ‘‚"
            }
        };

        function detectLanguage(text) {
            // More comprehensive Spanish patterns
            const spanishPatterns = [
                /[Ã¡Ã©Ã­Ã³ÃºÃ¼Ã±Â¿Â¡]/i,  // Spanish special characters
                /\b(hola|gracias|por|favor|como|estÃ¡|que|donde|cuando|porque|si|no|y|el|la|los|las|me|gusta|historia|hadas|cualquier|quiero|puedo|hacer|dice|muy|bien|mal|aquÃ­|allÃ­|esto|eso|mÃ¡s|menos)\b/i,  // Common Spanish words
                /\b(soy|eres|es|somos|son|estoy|estas|estamos|estÃ¡n|tengo|tienes|tiene|tenemos|tienen|voy|vas|va|vamos|van)\b/i,  // Spanish verbs
                /\b(un|una|unos|unas|este|esta|estos|estas|ese|esa|esos|esas|mi|tu|su|nuestro|nuestra|sus)\b/i  // Spanish articles and pronouns
            ];
            
            // Check for Spanish patterns
            for (const pattern of spanishPatterns) {
                if (pattern.test(text)) {
                    return 'es';
                }
            }
            return 'en';
        }

        function updateUILanguage(language) {
            if (currentLanguage === language) return;
            
            currentLanguage = language;
            const messageInput = document.getElementById('message-input');
            const sendButton = document.querySelector('.button-text');
            const emotionBubble = document.getElementById('emotion-bubble');
            
            messageInput.placeholder = UI_TEXT[language].placeholder;
            sendButton.textContent = UI_TEXT[language].sendButton;
            
            // Update emotion bubble text if it exists
            if (emotionBubble) {
                const currentEmotion = emotionBubble.className;
                emotionBubble.textContent = UI_TEXT[language][currentEmotion] || UI_TEXT[language].happy;
            }

            // Update voice recognition language
            if (recognition) {
                recognition.lang = language === 'es' ? 'es-ES' : 'en-US';
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/chat`);
            
            ws.onopen = () => {
                console.log('Connected to chat server');
                reconnectAttempts = 0;
                document.getElementById('send-button').classList.remove('disabled');
            };
            
            ws.onmessage = async (event) => {
                const response = JSON.parse(event.data);
                
                // Add the message to the chat first
                addMessage(response.text, 'bot', response.emotion);
                updateEmotionBubble(response.emotion);
                
                // Immediately attempt to play the audio
                if (response.audio) {
                    // Small delay to ensure the message is visible first
                    await new Promise(resolve => setTimeout(resolve, 100));
                    playAudioResponse(response.audio);
                }
            };
            
            ws.onclose = () => {
                console.log('Disconnected from chat server');
                document.getElementById('send-button').classList.add('disabled');
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(connectWebSocket, reconnectDelay);
                    reconnectAttempts++;
                }
            };
        }

        function updateEmotionBubble(emotion) {
            const emotionBubble = document.getElementById('emotion-bubble');
            emotionBubble.className = emotion || 'happy';
            emotionBubble.textContent = UI_TEXT[currentLanguage][emotion] || UI_TEXT[currentLanguage].happy;
        }

        function addMessage(text, sender, emotion) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            // Update the message text to include stethoscope for Dr. Snow Paws' second message
            if (text.includes("How can Dr. Snow Paws help you today?")) {
                text = text.replace("ðŸ˜º", "âš•ï¸");
            }
            
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            
            // Smooth scroll to the latest message
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            
            if (sender === 'bot') {
                updateEmotionBubble(emotion);
                playMessageSound(emotion);
            }
        }

        function playMessageSound(emotion) {
            // Add subtle sound effects for different emotions (optional)
            const sounds = {
                happy: new Audio('/static/assets/sounds/happy.mp3'),
                caring: new Audio('/static/assets/sounds/caring.mp3'),
                listening: new Audio('/static/assets/sounds/listening.mp3')
            };
            
            if (sounds[emotion]) {
                sounds[emotion].volume = 0.3;
                sounds[emotion].play().catch(() => {});
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                // Update UI language based on user input
                const detectedLanguage = detectLanguage(message);
                updateUILanguage(detectedLanguage);
                
                // Add message to chat
                addMessage(message, 'user');
                
                // Send to websocket
                ws.send(message);
                
                // Clear input
                input.value = '';
                
                // Add visual feedback
                const sendButton = document.getElementById('send-button');
                sendButton.classList.add('sent');
                setTimeout(() => sendButton.classList.remove('sent'), 200);
            }
        }

        document.getElementById('send-button').onclick = sendMessage;
        document.getElementById('message-input').onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };

        // Add input focus animation
        const messageInput = document.getElementById('message-input');
        messageInput.addEventListener('focus', () => {
            document.getElementById('input-container').classList.add('focused');
        });
        messageInput.addEventListener('blur', () => {
            document.getElementById('input-container').classList.remove('focused');
        });

        // Initialize emoji button
        document.querySelector('.input-emoji-button').onclick = () => {
            messageInput.value += 'ðŸ˜Š';
            messageInput.focus();
        };

        function playAudioResponse(audioData) {
            if (!isSpeechEnabled || !audioData) return;
            
            // Get the audio manager, with retry logic
            const getAudioManager = () => {
                return new Promise((resolve) => {
                    const tryGetManager = () => {
                        const manager = window.mobileAudioManager || (window.getMobileAudioManager && window.getMobileAudioManager());
                        if (manager) {
                            resolve(manager);
                        } else {
                            // Try again in 100ms, up to 5 times
                            if (window.audioManagerRetries < 5) {
                                window.audioManagerRetries = (window.audioManagerRetries || 0) + 1;
                                setTimeout(tryGetManager, 100);
                            } else {
                                console.warn('Could not get audio manager after retries');
                                resolve(null);
                            }
                        }
                    };
                    tryGetManager();
                });
            };

            // Try to play with the audio manager
            getAudioManager().then(audioManager => {
                if (audioManager) {
                    console.log('Playing audio with mobile manager');
                    audioManager.playAudioResponse(audioData).catch(error => {
                        console.error('Mobile audio playback failed:', error);
                        // Fallback to basic audio if the enhanced playback fails
                        playBasicAudio(audioData);
                    });
                } else {
                    console.log('Falling back to basic audio');
                    // Fallback to basic audio
                    playBasicAudio(audioData);
                }
            });
        }

        function playBasicAudio(audioData) {
            try {
                const audio = new Audio(`data:audio/mp3;base64,${audioData}`);
                audio.volume = 1.0;
                
                // Mobile-specific settings
                audio.playsinline = true;
                audio.setAttribute('webkit-playsinline', 'true');
                
                // Play with retry logic
                const playWithRetry = async (retries = 3) => {
                    try {
                        await audio.play();
                    } catch (error) {
                        console.warn(`Audio play attempt failed (${retries} retries left):`, error);
                        if (retries > 0) {
                            setTimeout(() => playWithRetry(retries - 1), 100);
                        }
                    }
                };
                
                playWithRetry();
            } catch (error) {
                console.error('Basic audio playback failed:', error);
            }
        }

        // Initialize audio handling
        document.addEventListener('DOMContentLoaded', function() {
            // Reset retries counter
            window.audioManagerRetries = 0;
            
            // Enable audio on first interaction (important for iOS)
            const enableAudio = async () => {
                try {
                    // Try to get the audio manager
                    const audioManager = await getAudioManager();
                    if (audioManager) {
                        await audioManager.setupMobileAudio();
                    }
                    
                    // Also try to initialize a basic audio context
                    const audio = new Audio();
                    audio.volume = 1.0;
                    await audio.play().catch(() => {});
                } catch (error) {
                    console.warn('Audio initialization error:', error);
                }
                
                document.removeEventListener('touchstart', enableAudio);
                document.removeEventListener('click', enableAudio);
            };
            
            document.addEventListener('touchstart', enableAudio, { once: true });
            document.addEventListener('click', enableAudio, { once: true });
            
            // Initialize audio control button
            const audioButton = document.getElementById('toggle-audio');
            isSpeechEnabled = localStorage.getItem('speechEnabled') !== 'false';
            updateAudioButtonState();
            
            audioButton.addEventListener('click', function() {
                isSpeechEnabled = !isSpeechEnabled;
                localStorage.setItem('speechEnabled', isSpeechEnabled);
                updateAudioButtonState();
                
                if (!isSpeechEnabled && window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio = null;
                }
            });
        });

        function updateAudioButtonState() {
            const audioButton = document.getElementById('toggle-audio');
            const audioIcon = audioButton.querySelector('.audio-icon');
            
            if (isSpeechEnabled) {
                audioIcon.textContent = 'ðŸ”Š';
                audioButton.classList.remove('muted');
            } else {
                audioIcon.textContent = 'ðŸ”‡';
                audioButton.classList.add('muted');
            }
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
        });

        // Add voice recognition functionality
        let recognition = null;
        let isListening = false;
        let isSpanishFailed = false;
        let silenceTimer = null;
        let lastSpeechTime = Date.now();
        let finalMessageToSend = '';  // Store the final message

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                
                // Always start with Spanish recognition
                recognition.lang = 'es-ES';
                
                recognition.onstart = function() {
                    isListening = true;
                    lastSpeechTime = Date.now();
                    document.getElementById('voice-input').classList.add('listening');
                    showVoiceFeedback(currentLanguage === 'es' ? 'Escuchando...' : 'Listening...');
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('voice-input').classList.remove('listening');
                    hideVoiceFeedback();
                    clearTimeout(silenceTimer);

                    if (finalMessageToSend) {
                        document.getElementById('message-input').value = finalMessageToSend;
                        setTimeout(() => {
                            sendMessage();
                            finalMessageToSend = '';
                        }, 100);
                    }
                };

                recognition.onresult = function(event) {
                    lastSpeechTime = Date.now();
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript = event.results[i][0].transcript.trim();
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    if (interimTranscript) {
                        showVoiceFeedback(interimTranscript);
                        document.getElementById('message-input').value = interimTranscript;
                    }

                    if (finalTranscript) {
                        // Check language of final transcript
                        const detectedLang = detectLanguage(finalTranscript);
                        if (detectedLang === 'es' || recognition.lang === 'es-ES') {
                            currentLanguage = 'es';
                            finalMessageToSend = finalTranscript;
                            recognition.stop();
                        } else {
                            currentLanguage = 'en';
                            finalMessageToSend = finalTranscript;
                            recognition.stop();
                        }
                        updateUILanguage(currentLanguage);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voice-input').classList.remove('listening');
                    hideVoiceFeedback();
                };
            }
        }

        function showVoiceFeedback(message) {
            const feedback = document.getElementById('voice-feedback');
            feedback.textContent = message;
            feedback.classList.add('visible');
        }

        function hideVoiceFeedback() {
            const feedback = document.getElementById('voice-feedback');
            feedback.classList.remove('visible');
        }

        function toggleVoiceInput() {
            if (!recognition) {
                initializeSpeechRecognition();
            }

            if (isListening) {
                recognition.stop();
            } else {
                // Reset Spanish failed flag
                isSpanishFailed = false;
                // Always start with Spanish
                recognition.lang = 'es-ES';
                recognition.start();
            }
        }

        // Initialize voice input button
        document.addEventListener('DOMContentLoaded', function() {
            const voiceButton = document.getElementById('voice-input');
            voiceButton.addEventListener('click', toggleVoiceInput);
            
            // Initialize speech recognition
            initializeSpeechRecognition();
        });

        connectWebSocket();

        // Add audio loading state management
        const audioFiles = {
            happy: '/static/assets/sounds/happy.mp3',
            caring: '/static/assets/sounds/caring.mp3',
            listening: '/static/assets/sounds/listening.mp3'
        };

        // Preload audio files
        const audioElements = {};
        Object.entries(audioFiles).forEach(([key, src]) => {
            const audio = new Audio();
            audio.preload = 'auto';
            audio.src = src;
            
            // Mobile-specific settings
            audio.playsinline = true;
            audio.setAttribute('webkit-playsinline', 'true');
            
            // Error handling
            audio.onerror = () => {
                console.warn(`Failed to load audio: ${key}`);
                // Fallback to silent operation if audio fails
                audioElements[key] = null;
            };
            
            audioElements[key] = audio;
        });

        // Function to play audio with fallback
        function playAudioWithFallback(type) {
            const audio = audioElements[type];
            if (audio) {
                audio.currentTime = 0;
                audio.volume = 1.0;
                audio.play().catch(error => {
                    console.warn('Audio playback failed:', error);
                    // Fallback behavior - continue without audio
                });
            }
        }
    </script>
</body>
</html>